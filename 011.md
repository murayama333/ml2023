# データの取り扱い - データフレームの操作

## サンプルデータの準備

```py
import pandas as pd

employees = {
    'id': [1, 2, 3, 4, 5],
    'name': ['Alice', 'Bob', 'Charlie', 'David', 'Ellen'],
    'department_id': [1, 1, 2, 2, 4]
}
df_employees = pd.DataFrame(employees)

departments = {
    'id': [1, 2, 3],
    'name': ['IT', 'Sales', 'Finance']
}
df_departments = pd.DataFrame(departments)

df_employees.to_csv("employees.csv", index=False)
df_departments.to_csv("departments.csv", index=False)
```

### サンプルデータ

#### employees.csv

```csv
id,name,department_id
1,Alice,1
2,Bob,1
3,Charlie,2
4,David,2
5,Ellen,4
```

#### departments.csv

```csv
id,name
1,IT
2,Sales
3,Finance
```

---

## データフレームの結合 - 内部結合

```py
df_employees = pd.read_csv("employees.csv")
df_departments = pd.read_csv("departments.csv")

pd.merge(df_employees, df_departments, 
         how='inner', left_on='department_id', right_on='id')
```

mergeメソッドの引数に `suffixes=('_emp', '_dept')` と指定することで、結合後の列名の接尾辞を指定できます。

---

## データフレームの結合 - 左外部結合

```py
pd.merge(df_employees, df_departments, 
         how='left', left_on='department_id', right_on='id')
```

* `how` 引数には以下の値を指定できる
  + `inner`
    - 内部結合
    - 両方のデータフレームに存在する共通のキーに基づいて結合する
    - 共通のキーを持たない行は結果に含まれない
  + `left`
    - 左外部結合
    - 左側のデータフレームのキーを基準に結合する
    - 右側のデータフレームに対応するキーがない場合、結果の該当行は欠損値で埋められる
  + `right`
    - 右外部結合
    - 右側のデータフレームのキーを基準に結合する
    - 左側のデータフレームに対応するキーがない場合、結果の該当行は欠損値で埋められる
  + `full`
    - 全外部結合（または外部結合）
    - 両方のデータフレームのキーを結合の基準とする
    - 片方または両方のデータフレームに存在しないキーの行は欠損値で埋められる
  + `cross`
    - クロス結合
    - 2つのデータフレーム間で全ての可能な行の組み合わせを作成する
    - 特定の結合キーは必要ない

---

## 参考：データフレームの基本操作

> `iris_data.csv` と `iris_target.csv` を事前にロードしておいてください。

```py
iris_data = pd.read_csv("iris_data.csv")
iris_target = pd.read_csv("iris_target.csv")
```

### 選択 (Selection):

```
SQL: SELECT * FROM table WHERE condition;
Pandas: df[df['column'] == condition]
```

* サンプルコード

```py
# - 選択
iris_data[iris_data["petal length (cm)"] > 6.0]
```

### 射影 (Projection):

```
SQL: SELECT column1, column2 FROM table;
Pandas: df[['column1', 'column2']]
```

* サンプルコード

```py
# - 射影
iris_data[["sepal length (cm)",	"sepal width (cm)"]]
```

### ソート (Sort):

```
SQL: SELECT * FROM table ORDER BY column ASC/DESC;
Pandas: df.sort_values(by='column', ascending=True/False)
```

* サンプルコード

```py
# - ソート
iris_data.sort_values(by='sepal length (cm)', ascending=False)

```

### グループ化 (Group By):

```
SQL: SELECT column, AGG_FUNC(column2) FROM table GROUP BY column;
Pandas: df.groupby('column').agg({'column2': 'agg_func'})
```

> `AGG_FUNC` とは `count` 関数や `sum` 関数ような集約関数（グループ関数）を意味します。

* サンプルコード

```py
iris_data.groupby('target').agg({'sepal length (cm)': ['min', 'max'], 
                                 'petal length (cm)': ['max', 'max']})
```

* サンプルコード - 2

```py
# - グループ化
iris_data.groupby('target').size()
```

### 結合 (Join):

```
SQL: SELECT * FROM table1 JOIN table2 ON table1.column = table2.column;
Pandas: pd.merge(table1, table2, on='column', how='join_type')
```

* サンプルコード

```py
# - 結合
pd.merge(iris_data, iris_target, on='target')
```
